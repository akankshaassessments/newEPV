{% extends "base_salesforce.html" %}

{% block title %}Finance Entry - {{ epv.epv_id }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Finance Entry - {{ epv.epv_id }}</h5>
                    <a href="{{ url_for('finance_dashboard') }}" class="btn btn-sm btn-secondary" title="Back to Dashboard">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                </div>
                <div class="card-body">
                    <!-- EPV Details -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>Expense Details</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th>EPV ID</th>
                                    <td>{{ epv.epv_id }}</td>
                                </tr>
                                <tr>
                                    <th>Employee</th>
                                    <td>{{ epv.employee_name }} ({{ epv.employee_id }})</td>
                                </tr>
                                <tr>
                                    <th>Cost Center</th>
                                    <td>{{ epv.cost_center_name }}</td>
                                </tr>
                                <tr>
                                    <th>City</th>
                                    <td>{{ epv.cost_center.city if epv.cost_center else 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>Submission Date</th>
                                    <td>{{ epv.submission_date.strftime('%d-%m-%Y') }}</td>
                                </tr>
                                <tr>
                                    <th>Total Amount</th>
                                    <td>₹{{ epv.total_amount|round(2) }}</td>
                                </tr>
                                <tr>
                                    <th>Invoice Type</th>
                                    <td>
                                        {% if epv.invoice_type == 'master' %}
                                            <span class="badge bg-primary">Master Invoice</span>
                                        {% elif epv.invoice_type == 'sub' %}
                                            <span class="badge bg-info">Sub Invoice</span>
                                        {% elif epv.invoice_type == 'split' %}
                                            <span class="badge bg-warning">Split Invoice</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Standard Invoice</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Merged PDF</th>
                                    <td>
                                        {% if epv.file_url %}
                                            <a href="{{ epv.file_url }}" target="_blank" class="btn btn-sm btn-primary">
                                                <i class="fas fa-file-pdf"></i> View PDF
                                            </a>
                                        {% else %}
                                            <span class="text-muted">No file available</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Expense Items</h6>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Expense Head</th>
                                            <th>Description</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in epv.items %}
                                        <tr>
                                            <td>{{ item.expense_head }}</td>
                                            <td>{{ item.description }}</td>
                                            <td>₹{{ item.amount|round(2) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Split Invoice Details for Master Invoices -->
                    {% if epv.invoice_type == 'master' %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Split Invoice Details</h6>
                                    <p class="text-muted small mb-0">This is a master invoice that has been split across multiple cost centers.</p>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Sub Invoice ID</th>
                                                    <th>Cost Center</th>
                                                    <th>Amount</th>
                                                    <th>Status</th>
                                                    <th>Approved By</th>
                                                    <th>Approval Date</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for sub in epv.sub_invoices %}
                                                <tr>
                                                    <td>{{ sub.epv_id }}</td>
                                                    <td>{{ sub.cost_center_name }}</td>
                                                    <td>₹{{ sub.total_amount|round(2) }}</td>
                                                    <td>
                                                        {% if sub.status == 'approved' %}
                                                            <span class="badge bg-success">Approved</span>
                                                        {% elif sub.status == 'rejected' %}
                                                            <span class="badge bg-danger">Rejected</span>
                                                        {% elif sub.status == 'pending_approval' %}
                                                            <span class="badge bg-warning text-dark">Pending Approval</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary">{{ sub.status|capitalize }}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% set approvals = sub.approvals|selectattr('status', 'equalto', 'approved')|list %}
                                                        {% if approvals %}
                                                            {{ approvals[-1].approver_name }}
                                                        {% else %}
                                                            -
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% set approvals = sub.approvals|selectattr('status', 'equalto', 'approved')|list %}
                                                        {% if approvals and approvals[-1].action_date %}
                                                            {{ approvals[-1].action_date.strftime('%d-%m-%Y') }}
                                                        {% else %}
                                                            -
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <a href="{{ url_for('epv_record', epv_id=sub.epv_id) }}" class="btn btn-sm btn-info" title="View">
                                                            <i class="fas fa-eye"></i> View
                                                        </a>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Split Invoice Allocation Details -->
                    {% if epv.invoice_type == 'split' %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Split Invoice Allocation Details</h6>
                                    <p class="text-muted small mb-0">This invoice has been split across multiple cost centers with different approvers.</p>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Cost Center</th>
                                                    <th>Expense Head</th>
                                                    <th>Allocated Amount</th>
                                                    <th>Approver</th>
                                                    <th>Status</th>
                                                    <th>Action Date</th>
                                                    <th>Comments</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for allocation in epv.allocations %}
                                                <tr>
                                                    <td>
                                                        <strong>{{ allocation.cost_center_name }}</strong>
                                                    </td>
                                                    <td>{{ allocation.expense_head or 'General' }}</td>
                                                    <td>
                                                        <span class="fw-bold text-primary">₹{{ allocation.allocated_amount|round(2) }}</span>
                                                    </td>
                                                    <td>
                                                        {{ allocation.approver_email }}
                                                    </td>
                                                    <td>
                                                        {% if allocation.status == 'approved' %}
                                                            <span class="badge bg-success">
                                                                <i class="fas fa-check"></i> Approved
                                                            </span>
                                                        {% elif allocation.status == 'rejected' %}
                                                            <span class="badge bg-danger">
                                                                <i class="fas fa-times"></i> Rejected
                                                            </span>
                                                        {% elif allocation.status == 'pending' %}
                                                            <span class="badge bg-warning">
                                                                <i class="fas fa-clock"></i> Pending
                                                            </span>
                                                        {% else %}
                                                            <span class="badge bg-secondary">{{ allocation.status|title }}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if allocation.action_date %}
                                                            {{ allocation.action_date.strftime('%d-%m-%Y %H:%M') }}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if allocation.rejection_reason %}
                                                            <span class="text-danger">{{ allocation.rejection_reason }}</span>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="card-footer bg-light">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <small class="text-muted">Total Amount:</small><br>
                                            <strong class="text-primary">₹{{ epv.total_amount|round(2) }}</strong>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted">Approved Amount:</small><br>
                                            <strong class="text-success">₹{{ epv.approved_amount|round(2) if epv.approved_amount else 0 }}</strong>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted">Rejected Amount:</small><br>
                                            <strong class="text-danger">₹{{ epv.rejected_amount|round(2) if epv.rejected_amount else 0 }}</strong>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted">Pending Amount:</small><br>
                                            <strong class="text-warning">₹{{ epv.pending_amount|round(2) if epv.pending_amount else 0 }}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Finance Entry Form -->
                    <form method="POST" action="{{ url_for('finance_entry', epv_id=epv.epv_id) }}">
                        <h6>Finance Entry Details</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="entry_date" class="form-label">Date of Entry</label>
                                <input type="date" class="form-control" id="entry_date" name="entry_date" value="{{ today.strftime('%Y-%m-%d') }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="vendor_name" class="form-label">Vendor Name</label>
                                <input type="text" class="form-control" id="vendor_name" name="vendor_name" required autocomplete="off">
                                <small id="vendorNameHelp" class="form-text text-muted">Start typing to see suggestions from previous entries</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="journal_entry" class="form-label">Journal Entry</label>
                                <input type="text" class="form-control" id="journal_entry" name="journal_entry" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="payment_voucher" class="form-label">Payment Voucher</label>
                                <input type="text" class="form-control" id="payment_voucher" name="payment_voucher" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="transaction_id" class="form-label">Transaction ID</label>
                                <input type="text" class="form-control" id="transaction_id" name="transaction_id" disabled>
                                <small class="text-muted">This field will be enabled after Finance Approver approval</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="payment_date" class="form-label">Date of Payment</label>
                                <input type="date" class="form-control" id="payment_date" name="payment_date" disabled>
                                <small class="text-muted">This field will be enabled after Finance Approver approval</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="amount" class="form-label">Amount</label>
                                <input type="number" step="0.01" class="form-control" id="amount" name="amount" value="{{ epv.total_amount }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="fcra_status" class="form-label">FCRA Status</label>
                                <select class="form-select" id="fcra_status" name="fcra_status" required>
                                    <option value="">Select FCRA Status</option>
                                    <option value="MUM FCRA">MUM FCRA</option>
                                    <option value="MUM NONFC">MUM NONFC</option>
                                    <option value="PUN FCRA">PUN FCRA</option>
                                    <option value="PUN NONFC">PUN NONFC</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="reason" class="form-label">Reason</label>
                            <input type="text" class="form-control" id="reason" name="reason">
                        </div>
                        <div class="mb-3">
                            <label for="comments" class="form-label">Comments</label>
                            <textarea class="form-control" id="comments" name="comments" rows="3"></textarea>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#rejectModal" title="Reject EPV">
                                <i class="fas fa-times me-1"></i> Reject
                            </button>
                            <button type="submit" class="btn btn-primary" title="Submit for Approval">
                                <i class="fas fa-paper-plane me-1"></i> Submit
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="rejectModalLabel">Reject EPV</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="rejectForm" action="{{ url_for('reject_finance_epv', epv_id=epv.epv_id) }}" method="POST">
                    <div class="mb-3">
                        <label for="rejection_type" class="form-label">Rejection Type</label>
                        <select class="form-select" id="rejection_type" name="rejection_type" required>
                            <option value="">Select rejection type</option>
                            <option value="upload_missing">Upload the missing document</option>
                            <option value="restart_process">Restart the whole process</option>
                        </select>
                        <div class="form-text">
                            <ul>
                                <li><strong>Upload the missing document</strong>: The submitter will be able to upload supplementary documents without restarting the approval process.</li>
                                <li><strong>Restart the whole process</strong>: The EPV will be fully rejected and the submitter will need to create a new EPV.</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="rejection_reason" class="form-label">Reason for Rejection</label>
                        <textarea class="form-control" id="rejection_reason" name="rejection_reason" rows="4" required></textarea>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Reject</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Vendor name autocomplete
        $("#vendor_name").autocomplete({
            source: "/api/vendors",
            minLength: 2,
            select: function(event, ui) {
                // Fill in vendor name
                $("#vendor_name").val(ui.item.value);
                $("#vendorNameHelp").text("Vendor selected from previous entries").removeClass("text-muted").addClass("text-success");
                return true;
            },
            response: function(event, ui) {
                // Show a message if no results found
                if (ui.content.length === 0) {
                    $("#vendorNameHelp").text("No matching vendors found - you can enter a new vendor name").removeClass("text-success").addClass("text-muted");
                } else {
                    $("#vendorNameHelp").text("Please select a vendor from the list or continue typing").removeClass("text-muted").addClass("text-info");
                }
            },
            change: function(event, ui) {
                // Reset help text when user types something not from the list
                if (!ui.item) {
                    $("#vendorNameHelp").text("Start typing to see suggestions from previous entries").removeClass("text-success text-info").addClass("text-muted");
                }
            },
            focus: function(event, ui) {
                // Prevent the input from being updated when hovering over items
                return false;
            }
        });

        // Clear help text styling when user starts typing
        $("#vendor_name").on('input', function() {
            if ($(this).val().length < 2) {
                $("#vendorNameHelp").text("Start typing to see suggestions from previous entries").removeClass("text-success text-info").addClass("text-muted");
            }
        });
    });
</script>
{% endblock %}